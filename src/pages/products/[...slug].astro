---
import Layout from '@/layouts/Layout.astro';
import { Providers } from '@/components/common/Providers';
import HeaderWrapper from '@/components/Header/HeaderWrapper';
import FooterV2 from '@/components/FooterV2';
import ProductDetail from '@/components/products/ProductDetail';
import { getProduct, getRelatedProducts } from '@/utils/products';
import { getImage } from 'astro:assets';

export const prerender = false;

const { slug } = Astro.params;
const currentPath = Astro.url.pathname;

// Parse the slug to handle both /products/:id and /products/:category/:id
const slugParts = slug?.split('/') || [];
const productId = slugParts.length > 1 ? slugParts[1] : slugParts[0];
const productCategory = slugParts.length > 1 ? slugParts[0] : undefined;

// Fetch the product data on-demand from the API (force fresh)
const product = productId ? await getProduct(productId) : undefined;

// If product not found, return 404
if (!product) {
  return new Response(null, {
    status: 404,
    statusText: 'Product Not Found'
  });
}

// Handle redirects if the slug is a normalized name instead of ID
function normalizeForUrl(str: string): string {
  return str.toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

if (product.name && slug === normalizeForUrl(product.name)) {
  const correctUrl = `/products/${(product.category || 'BOND').toLowerCase()}/${product.id}`;
  return Astro.redirect(correctUrl, 301);
}

// Format the product name for display
const productName = product?.name || product?.id || 'Product';
const productDescription = product?.description || `${productName} - High-performance industrial product from ForzaBuilt.`;

// Pre-optimize product image
let productOptimized = product;
if (product?.imageUrl) {
  try {
    const optimized = await getImage({ src: product.imageUrl, width: 800, format: 'webp' });
    productOptimized = { ...product, imageUrl: optimized.src };
  } catch (e) {
    console.warn(`Failed to optimize product image for ${product.id}`);
  }
}

// Get product image for Open Graph
const productOgImage = productOptimized?.imageUrl || "/logos/Forza-Eagle-Logo-Blue-eMail.png";

// Get related products on-demand
const relatedProducts = await getRelatedProducts(product.id, 4);

// Build product structured data for SEO
const productStructuredData = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": productName,
  "description": productDescription,
  "brand": {
    "@type": "Brand",
    "name": "ForzaBuilt"
  },
  "manufacturer": {
    "@type": "Organization",
    "name": "ForzaBuilt"
  },
  "category": product.category || "Industrial Products",
  ...(product.imageUrl && { "image": product.imageUrl }),
  "url": `https://forzabuilt.com${currentPath}`
};
---

<Layout 
  title={`${productName} - ForzaBuilt`}
  description={productDescription}
  canonicalUrl={currentPath}
  ogType="product"
  ogImage={productOgImage}
  structuredData={productStructuredData}
>
  <Providers client:load>
    <div class="bg-white min-h-screen flex flex-col relative overflow-x-hidden">
      <HeaderWrapper currentPath={currentPath} client:load />
      
      <ProductDetail 
        product={product} 
        relatedProducts={relatedProducts}
        productCategory={productCategory}
        client:load 
      />
      
      <FooterV2 client:load />
    </div>
  </Providers>
</Layout>
---

<Layout 
  title={`${productName} - ForzaBuilt`}
  description={productDescription}
  canonicalUrl={currentPath}
  ogType="product"
  ogImage={productOgImage}
  structuredData={productStructuredData}
>
  <Providers client:load>
    <div class="bg-white min-h-screen flex flex-col relative overflow-x-hidden">
      <HeaderWrapper currentPath={currentPath} client:load />
      
      <ProductDetail 
        product={product} 
        relatedProducts={relatedProducts}
        productCategory={productCategory}
        client:load 
      />
      
      <FooterV2 client:load />
    </div>
  </Providers>
</Layout>
